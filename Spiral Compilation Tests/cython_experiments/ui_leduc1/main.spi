open kivy
open lithe

union msg =
    | Clicked

type state = {
    p1 : nodes.player_funs agent.stateless leduc.card leduc.action f64
    p2 : nodes.player_funs agent.stateless leduc.card leduc.action f64
    text : string
    }

inl model (s : state) = function
    | Clicked => 
        open nodes
        inl Empty = player {probSelf=to_log_prob 1; observations=Nil; state=agent.stateless()} |> dyn
        inl r = leduc.game (nodes.cps.nodes_2p (s.p1, s.p2)) ((Empty,Empty),dyn id)
        inl ts = $"f\"Reward for player one is {!r}.\\n\"" : string
        {s with text#=fun t => $"!t + !ts"}

inl view dispatch (state : _ state) =
    inl (~+) x = +state x
    boxlayout [
        -orientation Vertical
        children [
            label [
                +text fun {text} => text
                -text_size (None, (Some: 200))
                ]
            boxlayout [
                -orientation Horizontal
                -size_hint_y 0.2
                children [
                    button [
                        -text "Start Game."
                        @on_press (fun () => dispatch Clicked)
                        ]
                    ]
                ]
            ]
        ]

inl main () =
    inl app = appm.create()
    inl p1 = agent.neural_random.create()
    inl p2 = agent.uniform_random.create()
    inl _ = rx.subscribe (loop {p1 p2 text=""} model view) (appm.root app)
    appm.run app