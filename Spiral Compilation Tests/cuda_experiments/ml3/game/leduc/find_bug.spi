open corebase
open corecuda
open corepython
open main
inl main() =
    open serializer

    inl seri = {
        msg = create_serializer
        game_state = create_serializer
        ui_state = create_serializer
    }

    inl ~msg = StartGame
    inl ~game_state = init()

    serialize seri.msg msg
    serialize seri.game_state game_state

    run fun () =>
        inl from = rangem.threads_in_grid().from
        if from = 0 then
            inl game_state = event_loop (deserialize seri.msg, deserialize seri.game_state)
            serialize seri.game_state game_state
            serialize seri.ui_state (game_to_ui game_state)

    $"cp.cuda.Stream.null.synchronize()"

    {
        game_state = jsonm.serialize (deserialize seri.game_state)
        ui_state = jsonm.serialize (deserialize seri.ui_state)
    }